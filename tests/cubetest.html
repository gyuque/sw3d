<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<script type="text/javascript" src="../sw3d/core/types.js"></script>
	<script type="text/javascript" src="../sw3d/core/geometry-core.js"></script>
	<script type="text/javascript" src="../sw3d/core/imagebuffer.js"></script>
	<script type="text/javascript" src="../sw3d/core/rasterizer.js"></script>
	<script type="text/javascript" src="../sw3d/core/rendering-context.js"></script>

	<script type="text/javascript" src="../sw3d/basic/geometry-basic.js"></script>
	<script type="text/javascript" src="../sw3d/extra/cube-generator.js"></script>
	
	<title>Cube Test</title>
	
	<script type="text/javascript">
		var gRenderingContext, gCanvas, gG;
		var SCREEN_WIDTH = 320;
		var SCREEN_HEIGHT = 240;
		var cube;
		
		function launch() {
			gCanvas = document.getElementById("out-canvas");
			gCanvas.width = SCREEN_WIDTH;
			gCanvas.height = SCREEN_HEIGHT;
			gG = gCanvas.getContext("2d");
			gRenderingContext = new smallworld3d.RenderingContext(SCREEN_WIDTH, SCREEN_HEIGHT);
			gRenderingContext.projectionTransform.perspectiveFOV(Math.PI/3.0, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 30);
			gRenderingContext.viewTransform.translate(0, 0, -4);

			cube = smallworld3d.generateCube(1,1,1, 3,3,3);
			prepareTransformedVertices(cube);
			
			document.body.parentNode.addEventListener("mousemove", onMouseMove, false);
		}
		
		function prepareTransformedVertices(obj) {
			var len = obj.vertices.length;
			var ls = [];
			for (var i = 0;i < len;i++) {
				ls.push(new smallworld3d.TransformedVertex());
			}
			
			obj.transformedVertices = ls;
		}
		
		function onMouseMove(e) {
			gRenderingContext.imageBuffer.emitToCanvas(gG);
			gRenderingContext.worldTransform.rotationY(e.clientX * 0.01);
			
			gRenderingContext.transformVertices(cube.transformedVertices, cube.vertices);
			gRenderingContext.applyViewportTransform(cube.transformedVertices);

			var r = gRenderingContext.rasterizer;
			gRenderingContext.imageBuffer.clearZ(1);
			gRenderingContext.imageBuffer.clearColor(0, 0, 0);
			
			var ls = cube.transformedVertices;
			for (var i = 0;i < ls.length;++i) {
				var v = ls[i];
				r.setVertexAttribute(0,
					v.position.x, v.position.y, v.position.z, // coordinate
					1.0 / v.position.w, // RHW
					255, 255, 0, 255,
					0, 0);
					
				r.plotPoint();
			}
		}
	</script>
</head>
<body onload="void launch();">
	<canvas id="out-canvas"></canvas>
</body>